<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Brain Dump</title>
    <link rel="stylesheet" href="style.css">
</head>

<body>
    <h1>Captain's log</h1>
    <div id="container">
        <div id="timestamp">Today</div>
        <textarea type="input" id="text"></textarea>
        <div id="buttonRow">
            <button id='exportButton' type="button">export</button>
            <button id='saveButton' type="button">Save</button>
        </div>
    </div>

    <script>
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', function () {
                navigator.serviceWorker
                    .register('/serviceworker.js')
                    .then((res) => console.log('service worker registered'))
                    .catch((err) => console.log('service worker not registered', err));
            });
        }

        const textArea = document.getElementById('text');
        const dateArea = document.getElementById('timestamp');
        const saveButton = document.getElementById('saveButton');
        const exportButton = document.getElementById('exportButton');

        const localLog = window.localStorage.getItem('log');

        let parsedLog = [];
        if (localLog && localLog !== 'undefined') {
            parsedLog = JSON.parse(localLog);
            parsedLog.forEach(el => {
                if (new Date(el.timestamp).getDay() === new Date().getDay()) {
                    textArea.value = el.entry;
                }
            });
        }

        // Handle saving
        const handleSave = () => {
            console.log(parsedLog);
            const lastEntry = parsedLog[parsedLog.length - 1];
            if (
                lastEntry &&
                new Date(lastEntry.timestamp).getDay() === new Date().getDay()
            ) {
                parsedLog[parsedLog.length - 1].entry = textArea.value;
            }
            else {
                const formatted = { entry: textArea.value, timestamp: new Date() }
                parsedLog.push(formatted);
            }

            window.localStorage.setItem('log', JSON.stringify(parsedLog));
        }

        // Handle typing
        // @TODO: switch to save after 1-2 seconds of inactivity after typing
        const handleKeyPress = (e) => {
            if (e.code === 'Tab') {
                e.preventDefault();
                textArea.value += '    ';
            }
            if (e.ctrlKey && e.code === 'KeyS') {
                e.preventDefault();
                handleSave()
            }
            if (e.ctrlKey && e.code === 'Enter') {
                e.preventDefault();
                handleSave()
            }
        }

        // Export all entries
        const handleExport = () => {
            var file = new Blob([JSON.stringify(parsedLog)], { type: 'text/json' });
            var a = document.createElement("a"),
                url = URL.createObjectURL(file);
            a.href = url;
            a.download = 'log.json';
            document.body.appendChild(a);
            a.click();
            setTimeout(function () {
                document.body.removeChild(a);
                window.URL.revokeObjectURL(url);
            }, 0);
        }

        textArea.addEventListener('keydown', handleKeyPress)
        saveButton.addEventListener('click', handleSave);
        exportButton.addEventListener('click', handleExport);
        dateArea.innerText = new Date();
    </script>
</body>

</html>